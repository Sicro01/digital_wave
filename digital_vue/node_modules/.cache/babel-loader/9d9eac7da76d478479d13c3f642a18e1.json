{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport CardIcons from '@/components/shared/CardIcons';\n// import axios from 'axios'\n\nexport default {\n  name: 'TargetChannelCard',\n  components: {\n    CardIcons\n  },\n  data() {\n    return {\n      // rows: [],\n      headerRow: [],\n      headers: [],\n      items: [],\n      itemLabels: [],\n      budgetValues: [],\n      countryChannelData: [],\n      locked: true,\n      valid: false,\n      rules: {\n        required: v => !!v || \"Required\",\n        notEmpty: v => v.toString().length > 0 || \"Budget should be between 0 and 10,000,000\",\n        inRange: v => Number.isInteger(Number(v)) && v >= 0 && v <= 10000000 || \"Budget should be between 0 and 10,000,000\"\n      }\n    };\n  },\n  computed: {\n    selectedPhase: {\n      get() {\n        return this.$store.state.selectedPhaseData.phase;\n      }\n    },\n    selectedStrategy: {\n      get() {\n        return this.$store.state.selectedStrategyData.strategy;\n      }\n    },\n    storedTargetCountries: {\n      get() {\n        return this.$store.state.storedTargetCountries;\n      }\n    },\n    storedTargetChannels: {\n      get() {\n        return this.$store.state.storedTargetChannels;\n      }\n    },\n    storedCountries: {\n      get() {\n        return this.$store.state.storedCountries;\n      }\n    },\n    storedChannels: {\n      get() {\n        return this.$store.state.storedChannels;\n      }\n    },\n    targetChannelsLastEdited: {\n      get() {\n        if (this.storedTargetChannels.length > 0) {\n          let lastEditDate = new Date(Math.max(...this.storedTargetChannels.map(e => new Date(e.date_modified)))).toLocaleDateString('en-GB');\n          let lastEditTime = new Date(Math.max(...this.storedTargetChannels.map(e => new Date(e.date_modified)))).toLocaleTimeString('en-GB');\n          return `${lastEditDate} ${lastEditTime}`;\n        } else {\n          return 'N/A';\n        }\n      }\n    }\n  },\n  watch: {\n    async storedTargetCountries(newValue) {\n      console.log('TargetChannelCard: watch: storedTargetCountries', this.storedTargetCountries);\n      await this.createHeaders();\n      await this.createItems();\n      // await this.createHeaders()\n      // await this.createItemLabels()\n      // await this.createDataItems()\n    }\n  },\n\n  mounted() {\n    // this.createHeaders()\n    // this.createItemLabels()\n    // this.createDataItems()\n    this.createItems();\n    this.createHeaders();\n  },\n  methods: {\n    createItems() {\n      this.items = [];\n      console.log('storedTargetChannels:', this.storedTargetChannels);\n      this.storedChannels.forEach(ch => {\n        console.log('ch:', ch);\n        let item = {\n          ...ch\n        };\n        item.countries = [];\n        this.storedTargetCountries.forEach(tco => {\n          console.log('tco:', tco);\n          console.log(this.storedTargetChannels.find(tch => tch.channel === ch.id && tch.target_country === tco.id));\n          let found_target_channel = this.storedTargetChannels.find(tch => tch.channel === ch.id && tch.target_country === tco.id);\n          if (found_target_channel) {\n            console.log('found_target_channel-found:', found_target_channel);\n            item.countries.push({\n              target_country_id: tco.id,\n              auto_allocate: found_target_channel.auto_allocate,\n              budget: found_target_channel.budget\n            });\n          } else {\n            console.log('found_target_channel-NOT-found:', tch.channel, ch.id, tch.target_country, tco.id);\n            item.countries.push({\n              target_country_id: tco.id,\n              auto_allocate: false,\n              budget: ''\n            });\n          }\n        });\n        this.items.push(item);\n      });\n      console.log('items:', this.items);\n    },\n    createHeaders() {\n      this.headerRow = [];\n      let channel = {\n        text: 'Channel',\n        align: 'center',\n        sortable: false,\n        value: 'code',\n        class: \"black--text text-subtitle-1\",\n        width: \"50px\"\n      };\n      this.headerRow.push(channel);\n      this.storedTargetCountries.map(tco => {\n        // Create a header for each country - where we'll place a checkbox \n        var country = {\n          text: tco.code,\n          align: 'start',\n          sortable: false,\n          value: \"auto_allocate\",\n          class: \"black--text text-subtitle-1\",\n          width: \"50px\"\n        };\n        this.headerRow.push(country);\n\n        // Create a header for each country budget - where we'll place a budget field\n        var budget = {\n          text: 'Budget',\n          align: 'center',\n          sortable: false,\n          value: \"budget\",\n          class: \"black--text text-subtitle-1\",\n          width: \"150px\"\n        };\n        this.headerRow.push(budget);\n      });\n      // console.log('createHeaders:', this.headerRow)\n    },\n\n    save() {\n      let newTargetChannelObjects = [];\n      this.items.map(i => {\n        console.log(i);\n        i.countries.map(c => {\n          if (c.auto_allocate) {\n            let obj = {\n              channel: i.id,\n              target_country: c.target_country_id,\n              code: i.code,\n              name: i.name,\n              auto_allocate: c.auto_allocate,\n              budget: c.budget,\n              budget_allocated: 0\n            };\n            newTargetChannelObjects.push(obj);\n          }\n        });\n      });\n      console.log('newTargetChannelObjects:', newTargetChannelObjects);\n\n      // Which countries has the user deleted?\n      console.log('this.storedTargetChannels:', this.storedTargetChannels);\n      var deleteTargetChannelIds = this.testDiff(newTargetChannelObjects);\n      console.log('deleteTargetChannelIds:', deleteTargetChannelIds);\n      this.$emit('update-target-channels', newTargetChannelObjects, deleteTargetChannelIds);\n      this.locked = true;\n    },\n    testDiff(newTargetChannelObjects) {\n      function diffArray(newTargetChannelObjects, oldItem) {\n        for (let newItem of newTargetChannelObjects) {\n          if (newItem.target_country_id === oldItem.target_country_id && newItem.channel_id === oldItem.channel_id) {\n            return true;\n          }\n        }\n        return false;\n      }\n      let deleteTargetChannelIds = [];\n      this.storedTargetChannels.forEach(current_tch => {\n        if (!diffArray(newTargetChannelObjects, current_tch)) {\n          deleteTargetChannelIds.push(current_tch);\n        }\n      });\n      return deleteTargetChannelIds;\n    },\n    diffArray(oldIdsArray, newIdsArray) {\n      // Identify which target channels the user has deleted\n      function diffArray(oldTargetChannelIds, newTargetChannelIds) {\n        return [...diff(oldTargetChannelIds, newTargetChannelIds)];\n        function diff(a, b) {\n          return a.filter(item => b.indexOf(item) === -1);\n        }\n      }\n      // What user originally picked - just the country id's\n      var oldTargetChannelIds = this.storedTargetChannels.map(c => c.country);\n\n      // What user has now picked - just the country id's\n      var newTargetChannelIds = this.items.filter(i => i.include).map(i => i.country_id);\n      return diffArray(oldIdsArray, newIdsArray);\n    },\n    cancel() {\n      this.locked = true;\n      // this.createItems()\n    },\n\n    includeChange(item, itemIndex, country, countryIndex) {\n      !country.auto_allocate ? country.budget = '' : null;\n    },\n    newItems() {\n      let i = [];\n      this.storedChannels.forEach(channel => {\n        let ch = {\n          ...channel\n        };\n        ch.target_countries = [];\n        console.log('ch:', ch);\n        console.log('ch array langth:', ch.target_countries.length);\n        this.storedTargetCountries.forEach((target_country, index) => {\n          console.log('target_country:', target_country);\n          // If target channel exists then  populate displayed info with correct values\n          if (this.storedTargetChannels.length > 0) {\n            console.log('searching stored_channels:', this.storedTargetChannels);\n            let found_target_channel = this.storedTargetChannels.find(target_channel => target_channel.code === ch.code && target_country.code === target_channel.country);\n            if (found_target_channel) {\n              console.log('existing target_channel found');\n              let country = {\n                auto_allocate: found_target_channel.auto_allocate,\n                budget: found_target_channel.budget\n              };\n              ch.target_countries.push(country);\n            } else {\n              console.log('existing target_channel NOT found');\n              let country = {\n                auto_allocate: false,\n                budget: 'a'\n              };\n              ch.target_countries.push(country);\n            }\n          } else {\n            console.log('no stored_channels exist');\n            let country = {\n              auto_allocate: false,\n              budget: ''\n            };\n            ch.target_countries.push(country);\n          }\n        });\n        i.push(ch);\n        console.log('i:', i);\n      });\n      // console.log(i)\n      i.forEach(i => {\n        console.log(i.code);\n        i.target_countries.forEach(c => {\n          console.log(c.auto_allocate, c.budget);\n        });\n      });\n      // console.log(output)\n    }\n  }\n};","map":{"version":3,"mappings":";AAwIA;AACA;;AAEA;EACAA;EACAC;IACAC;EACA;EACAC;IACA;MACA;MACAC;MACAC;MACAC;MACAC;MACAC;MACAC;MACAC;MACAC;MACAC;QACAC;QACAC;QACAC;MACA;IACA;EACA;EACAC;IACAC;MACAC;QACA;MACA;IACA;IACAC;MACAD;QACA;MACA;IACA;IACAE;MACAF;QACA;MACA;IACA;IACAG;MACAH;QACA;MACA;IACA;IACAI;MACAJ;QACA;MACA;IACA;IACAK;MACAL;QACA;MACA;IACA;IACAM;MACAN;QACA;UACA;UACA;UACA;QACA;UACA;QACA;MACA;IACA;EACA;EACAO;IACA;MACAC;MACA;MACA;MACA;MACA;MACA;IACA;EACA;;EACAC;IACA;IACA;IACA;IACA;IACA;EACA;EACAC;IACAC;MACA;MACAH;MACA;QACAA;QACA;UAAA;QAAA;QACAI;QACA;UACAJ;UACAA,sCACAK;UACA,qDACAA;UACA;YACAL;YACAI;cACAE;cACAC;cACAC;YACA;UACA;YACAR;YACAI;cACAE;cACAC;cACAC;YACA;UACA;QACA;QACA;MACA;MACAR;IACA;IACAS;MACA;MACA;QACAC;QACAC;QACAC;QACAC;QACAC;QACAC;MACA;MACA;MACA;QACA;QACA;UACAL;UACAC;UACAC;UACAC;UACAC;UACAC;QACA;QACA;;QAEA;QACA;UACAL;UACAC;UACAC;UACAC;UACAC;UACAC;QACA;QACA;MACA;MACA;IACA;;IACAC;MACA;MACA;QACAhB;QACAiB;UACA;YACA;cACAC;cACAC;cACAC;cACA9C;cACAiC;cACAC;cACAa;YACA;YACAC;UACA;QACA;MACA;MACAtB;;MAEA;MACAA;MACA;MACAA;MACA;MACA;IACA;IACAuB;MACA;QACA;UACA;YACA;UACA;QACA;QACA;MACA;MACA;MACA;QACA;UACAC;QACA;MACA;MACA;IACA;IACAC;MACA;MACA;QACA;QAEA;UACA;QACA;MACA;MACA;MACA;;MAEA;MACA;MACA;IACA;IACAC;MACA;MACA;IACA;;IACAC;MACA;IACA;IACAC;MACA;MACA;QACA;UAAA;QAAA;QACAC;QACA7B;QACAA;QACA;UACAA;UACA;UACA;YACAA;YACA,4EACA8B;YACA;cACA9B;cACA;gBACAO;gBACAC;cACA;cACAqB;YACA,OACA;cACA7B;cACA;gBACAO;gBACAC;cACA;cACAqB;YACA;UACA,OACA;YACA7B;YACA;cACAO;cACAC;YACA;YACAqB;UACA;QAEA;QACAZ;QACAjB;MACA;MACA;MACAiB;QACAjB;QACAiB;UACAjB;QACA;MACA;MACA;IACA;EAEA;AACA","names":["name","components","CardIcons","data","headerRow","headers","items","itemLabels","budgetValues","countryChannelData","locked","valid","rules","required","notEmpty","inRange","computed","selectedPhase","get","selectedStrategy","storedTargetCountries","storedTargetChannels","storedCountries","storedChannels","targetChannelsLastEdited","watch","console","mounted","methods","createItems","item","find","target_country_id","auto_allocate","budget","createHeaders","text","align","sortable","value","class","width","save","i","channel","target_country","code","budget_allocated","newTargetChannelObjects","testDiff","deleteTargetChannelIds","diffArray","cancel","includeChange","newItems","ch","target_channel"],"sourceRoot":"src/components/targetchannel","sources":["TargetChannelCard.vue"],"sourcesContent":["<template>\r\n    <v-form\r\n        ref=\"form\"\r\n        v-model=\"valid\">\r\n        <v-card class=\"mt-3 mx-3\">\r\n            <v-card-title class=\"py-0\">\r\n                Select Channels and Set Budgets for Target Countries\r\n                <v-spacer></v-spacer>\r\n                <CardIcons\r\n                    :showEditIcon=\"true\"\r\n                    :showHideIcon=\"true\"\r\n                    @edit=\"(locked = !locked)\"\r\n                    @hide=\"$emit('hide')\"\r\n                    cardType=\"Linked Channels\" />\r\n            </v-card-title>\r\n            <v-divider></v-divider>\r\n            <v-card-text>\r\n                <v-row class=\"text--disabled\">\r\n                    <v-col cols=\"auto\" class=\"py-0 d-flex align-center\">Phase Budget:</v-col>\r\n                    <v-col cols=\"auto\" class=\"d-flex align-center\">\r\n                        <v-text-field\r\n                            :value=\"selectedPhase.budget\"\r\n                            label=\"Budget\"\r\n                            outlined\r\n                            dense\r\n                            disabled\r\n                            hide-details>\r\n                        </v-text-field>\r\n                        <v-col cols=\"auto\" class=\"py-0 d-flex align-center\">\r\n                            <v-text-field\r\n                                :value=\"selectedPhase.auto_allocate ? 'Yes' : 'No'\"\r\n                                label=\"Budget Autoallocated?\"\r\n                                outlined\r\n                                dense\r\n                                disabled\r\n                                hide-details>\r\n                            </v-text-field>\r\n                        </v-col>\r\n                    </v-col>\r\n                    <v-col cols=\"auto\" class=\"py-0 d-flex align-center\">Strategy Budget:</v-col>\r\n                    <v-col cols=\"auto\" class=\"d-flex align-center\">\r\n                        <v-text-field\r\n                            :value=\"selectedStrategy.budget\"\r\n                            label=\"Budget\"\r\n                            outlined\r\n                            dense\r\n                            disabled\r\n                            hide-details>\r\n                        </v-text-field>\r\n                        <v-col cols=\"auto\" class=\"py-0 d-flex align-center\">\r\n                            <v-text-field\r\n                                :value=\"selectedStrategy.auto_allocate ? 'Yes' : 'No'\"\r\n                                label=\"Budget Autoallocated?\"\r\n                                outlined\r\n                                dense\r\n                                disabled\r\n                                hide-details>\r\n                            </v-text-field>\r\n                        </v-col>\r\n                    </v-col>\r\n                </v-row>\r\n            </v-card-text>\r\n\r\n            <v-card-text>\r\n                <v-sheet\r\n                    class=\"mb-3 grey\"\r\n                    tile\r\n                    outlined>\r\n                    <v-data-table\r\n                        :headers=\"headerRow\"\r\n                        :items=\"items\"\r\n                        hide-default-footer\r\n                        class=\"pb-3\">\r\n\r\n                        <template v-slot:body=\"{ items }\">\r\n                            <tbody>\r\n                                <tr v-for=\"(item, itemIndex) in items\">\r\n                                    <td>{{ item.code }}</td>\r\n                                    <template v-for=\"(country, countryIndex) in item.countries\">\r\n                                        <td>\r\n                                            <v-checkbox\r\n                                                v-model=\"country.auto_allocate\"\r\n                                                color=\"secondary\"\r\n                                                :readonly=\"locked\"\r\n                                                dense\r\n                                                hide-details\r\n                                                @change=\"includeChange(item, itemIndex, country, countryIndex)\"></v-checkbox>\r\n                                            </v-checkbox>\r\n                                        </td>\r\n                                        <td>\r\n                                            <v-text-field\r\n                                                v-model=\"country.budget\"\r\n                                                :readonly=\"locked\"\r\n                                                :disabled=\"!country.auto_allocate\"\r\n                                                :rules=\"country.auto_allocate ? [rules.notEmpty, rules.inRange] : []\"\r\n                                                label=\"Budget\"\r\n                                                type=\"number\"\r\n                                                dense\r\n                                                hide-details\r\n                                                class=\"shrink rounded-0\"\r\n                                                outlined>\r\n                                            </v-text-field>\r\n                                        </td>\r\n                                    </template>\r\n                                </tr>\r\n                            </tbody>\r\n                        </template>\r\n                    </v-data-table>\r\n                </v-sheet>\r\n                <div class=\"caption text--disabled\">\r\n                    <span>Last edit: {{ targetChannelsLastEdited }}</span>\r\n                    <!-- <span>Last edit:{{ targetCountriesLastEdited.toLocaleDateString((\"en-GB\")) }}</span>\r\n                    <span> {{ targetCountriesLastEdited.toLocaleTimeString((\"en-GB\")) }}</span> -->\r\n                </div>\r\n            </v-card-text>\r\n            <v-card-actions v-if=\"!locked\">\r\n                <v-spacer></v-spacer>\r\n                <v-btn\r\n                    class=\"grey lighten-1 mr-3 rounded-0 text-capitalize\"\r\n                    light\r\n                    depressed\r\n                    @click=\"cancel\">\r\n                    Cancel\r\n                </v-btn>\r\n                <v-btn\r\n                    class=\"mr-3 success rounded-0 text-capitalize\"\r\n                    depressed\r\n                    :disabled=\"(!valid)\"\r\n                    @click=\"save\">\r\n                    Save\r\n                </v-btn>\r\n            </v-card-actions>\r\n        </v-card>\r\n    </v-form>\r\n</template>\r\n<script>\r\nimport CardIcons from '@/components/shared/CardIcons'\r\n// import axios from 'axios'\r\n\r\nexport default {\r\n    name: 'TargetChannelCard',\r\n    components: {\r\n        CardIcons,\r\n    },\r\n    data() {\r\n        return {\r\n            // rows: [],\r\n            headerRow: [],\r\n            headers: [],\r\n            items: [],\r\n            itemLabels: [],\r\n            budgetValues: [],\r\n            countryChannelData: [],\r\n            locked: true,\r\n            valid: false,\r\n            rules: {\r\n                required: (v => !!v || \"Required\"),\r\n                notEmpty: (v => (v.toString().length > 0) || \"Budget should be between 0 and 10,000,000\"),\r\n                inRange: (v => (Number.isInteger(Number(v)) && v >= 0 && v <= 10000000) || \"Budget should be between 0 and 10,000,000\"),\r\n            },\r\n        }\r\n    },\r\n    computed: {\r\n        selectedPhase: {\r\n            get() {\r\n                return this.$store.state.selectedPhaseData.phase\r\n            }\r\n        },\r\n        selectedStrategy: {\r\n            get() {\r\n                return this.$store.state.selectedStrategyData.strategy\r\n            }\r\n        },\r\n        storedTargetCountries: {\r\n            get() {\r\n                return this.$store.state.storedTargetCountries\r\n            }\r\n        },\r\n        storedTargetChannels: {\r\n            get() {\r\n                return this.$store.state.storedTargetChannels\r\n            }\r\n        },\r\n        storedCountries: {\r\n            get() {\r\n                return this.$store.state.storedCountries\r\n            }\r\n        },\r\n        storedChannels: {\r\n            get() {\r\n                return this.$store.state.storedChannels\r\n            }\r\n        },\r\n        targetChannelsLastEdited: {\r\n            get() {\r\n                if (this.storedTargetChannels.length > 0) {\r\n                    let lastEditDate = new Date(Math.max(...this.storedTargetChannels.map(e => new Date(e.date_modified)))).toLocaleDateString('en-GB');\r\n                    let lastEditTime = new Date(Math.max(...this.storedTargetChannels.map(e => new Date(e.date_modified)))).toLocaleTimeString('en-GB');\r\n                    return `${lastEditDate} ${lastEditTime}`\r\n                } else {\r\n                    return 'N/A'\r\n                }\r\n            }\r\n        }\r\n    },\r\n    watch: {\r\n        async storedTargetCountries(newValue) {\r\n            console.log('TargetChannelCard: watch: storedTargetCountries', this.storedTargetCountries)\r\n            await this.createHeaders()\r\n            await this.createItems()\r\n            // await this.createHeaders()\r\n            // await this.createItemLabels()\r\n            // await this.createDataItems()\r\n        },\r\n    },\r\n    mounted() {\r\n        // this.createHeaders()\r\n        // this.createItemLabels()\r\n        // this.createDataItems()\r\n        this.createItems()\r\n        this.createHeaders()\r\n    },\r\n    methods: {\r\n        createItems() {\r\n            this.items = []\r\n            console.log('storedTargetChannels:', this.storedTargetChannels)\r\n            this.storedChannels.forEach(ch => {\r\n                console.log('ch:', ch)\r\n                let item = { ...ch }\r\n                item.countries = []\r\n                this.storedTargetCountries.forEach(tco => {\r\n                    console.log('tco:', tco)\r\n                    console.log(this.storedTargetChannels\r\n                        .find(tch => tch.channel === ch.id && tch.target_country === tco.id))\r\n                    let found_target_channel = this.storedTargetChannels\r\n                        .find(tch => tch.channel === ch.id && tch.target_country === tco.id)\r\n                    if (found_target_channel) {\r\n                        console.log('found_target_channel-found:', found_target_channel)\r\n                        item.countries.push({\r\n                            target_country_id: tco.id,\r\n                            auto_allocate: found_target_channel.auto_allocate,\r\n                            budget: found_target_channel.budget\r\n                        })\r\n                    } else {\r\n                        console.log('found_target_channel-NOT-found:', tch.channel, ch.id, tch.target_country, tco.id)\r\n                        item.countries.push({\r\n                            target_country_id: tco.id,\r\n                            auto_allocate: false,\r\n                            budget: ''\r\n                        })\r\n                    }\r\n                })\r\n                this.items.push(item)\r\n            })\r\n            console.log('items:', this.items)\r\n        },\r\n        createHeaders() {\r\n            this.headerRow = []\r\n            let channel = {\r\n                text: 'Channel',\r\n                align: 'center',\r\n                sortable: false,\r\n                value: 'code',\r\n                class: \"black--text text-subtitle-1\",\r\n                width: \"50px\",\r\n            }\r\n            this.headerRow.push(channel)\r\n            this.storedTargetCountries.map(tco => {\r\n                // Create a header for each country - where we'll place a checkbox \r\n                var country = {\r\n                    text: tco.code,\r\n                    align: 'start',\r\n                    sortable: false,\r\n                    value: \"auto_allocate\",\r\n                    class: \"black--text text-subtitle-1\",\r\n                    width: \"50px\",\r\n                }\r\n                this.headerRow.push(country)\r\n\r\n                // Create a header for each country budget - where we'll place a budget field\r\n                var budget = {\r\n                    text: 'Budget',\r\n                    align: 'center',\r\n                    sortable: false,\r\n                    value: \"budget\",\r\n                    class: \"black--text text-subtitle-1\",\r\n                    width: \"150px\",\r\n                }\r\n                this.headerRow.push(budget)\r\n            })\r\n            // console.log('createHeaders:', this.headerRow)\r\n        },\r\n        save() {\r\n            let newTargetChannelObjects = []\r\n            this.items.map(i => {\r\n                console.log(i)\r\n                i.countries.map(c => {\r\n                    if (c.auto_allocate) {\r\n                        let obj = {\r\n                            channel: i.id,\r\n                            target_country: c.target_country_id,\r\n                            code: i.code,\r\n                            name: i.name,\r\n                            auto_allocate: c.auto_allocate,\r\n                            budget: c.budget,\r\n                            budget_allocated: 0,\r\n                        }\r\n                        newTargetChannelObjects.push(obj)\r\n                    }\r\n                })\r\n            })\r\n            console.log('newTargetChannelObjects:', newTargetChannelObjects)\r\n\r\n            // Which countries has the user deleted?\r\n            console.log('this.storedTargetChannels:', this.storedTargetChannels)\r\n            var deleteTargetChannelIds = this.testDiff(newTargetChannelObjects)\r\n            console.log('deleteTargetChannelIds:', deleteTargetChannelIds)\r\n            this.$emit('update-target-channels', newTargetChannelObjects, deleteTargetChannelIds)\r\n            this.locked = true\r\n        },\r\n        testDiff(newTargetChannelObjects) {\r\n            function diffArray(newTargetChannelObjects, oldItem) {\r\n                for (let newItem of newTargetChannelObjects) {\r\n                    if (newItem.target_country_id === oldItem.target_country_id && newItem.channel_id === oldItem.channel_id) {\r\n                        return true\r\n                    }\r\n                }\r\n                return false\r\n            }\r\n            let deleteTargetChannelIds = []\r\n            this.storedTargetChannels.forEach(current_tch => {\r\n                if (!diffArray(newTargetChannelObjects, current_tch)) {\r\n                    deleteTargetChannelIds.push(current_tch)\r\n                }\r\n            })\r\n            return deleteTargetChannelIds\r\n        },\r\n        diffArray(oldIdsArray, newIdsArray) {\r\n            // Identify which target channels the user has deleted\r\n            function diffArray(oldTargetChannelIds, newTargetChannelIds) {\r\n                return [...diff(oldTargetChannelIds, newTargetChannelIds)];\r\n\r\n                function diff(a, b) {\r\n                    return a.filter(item => b.indexOf(item) === -1)\r\n                }\r\n            }\r\n            // What user originally picked - just the country id's\r\n            var oldTargetChannelIds = this.storedTargetChannels.map(c => c.country)\r\n\r\n            // What user has now picked - just the country id's\r\n            var newTargetChannelIds = this.items.filter(i => i.include).map(i => i.country_id)\r\n            return diffArray(oldIdsArray, newIdsArray)\r\n        },\r\n        cancel() {\r\n            this.locked = true\r\n            // this.createItems()\r\n        },\r\n        includeChange(item, itemIndex, country, countryIndex) {\r\n            !country.auto_allocate ? country.budget = '' : null\r\n        },\r\n        newItems() {\r\n            let i = []\r\n            this.storedChannels.forEach(channel => {\r\n                let ch = { ...channel }\r\n                ch.target_countries = []\r\n                console.log('ch:', ch)\r\n                console.log('ch array langth:', ch.target_countries.length)\r\n                this.storedTargetCountries.forEach((target_country, index) => {\r\n                    console.log('target_country:', target_country)\r\n                    // If target channel exists then  populate displayed info with correct values\r\n                    if (this.storedTargetChannels.length > 0) {\r\n                        console.log('searching stored_channels:', this.storedTargetChannels)\r\n                        let found_target_channel = this.storedTargetChannels.find(target_channel =>\r\n                            target_channel.code === ch.code && target_country.code === target_channel.country)\r\n                        if (found_target_channel) {\r\n                            console.log('existing target_channel found')\r\n                            let country = {\r\n                                auto_allocate: found_target_channel.auto_allocate,\r\n                                budget: found_target_channel.budget,\r\n                            }\r\n                            ch.target_countries.push(country)\r\n                        }\r\n                        else {\r\n                            console.log('existing target_channel NOT found')\r\n                            let country = {\r\n                                auto_allocate: false,\r\n                                budget: 'a',\r\n                            }\r\n                            ch.target_countries.push(country)\r\n                        }\r\n                    }\r\n                    else {\r\n                        console.log('no stored_channels exist')\r\n                        let country = {\r\n                            auto_allocate: false,\r\n                            budget: '',\r\n                        }\r\n                        ch.target_countries.push(country)\r\n                    }\r\n\r\n                })\r\n                i.push(ch)\r\n                console.log('i:', i)\r\n            })\r\n            // console.log(i)\r\n            i.forEach(i => {\r\n                console.log(i.code)\r\n                i.target_countries.forEach(c => {\r\n                    console.log(c.auto_allocate, c.budget)\r\n                })\r\n            })\r\n            // console.log(output)\r\n        },\r\n\r\n    }\r\n}\r\n</script>\r\n<style scoped>\r\ntable>tbody>tr>td:nth-child(1),\r\ntable>thead>tr>th:nth-child(1) {\r\n    position: sticky !important;\r\n    position: -webkit-sticky !important;\r\n    left: 0;\r\n    z-index: 9998;\r\n    background: white;\r\n}\r\n\r\ntable>thead>tr>th:nth-child(1) {\r\n    z-index: 9999;\r\n}\r\n</style>\r\n<!-- // Build array of countries\r\n            // var targetCountries = []\r\n            // this.items.forEach((item) => {\r\n            //     if (item.include) {\r\n            //         let itemObj = {\r\n            //             strategy: this.selectedStrategy.id,\r\n            //             country: item.country_id,\r\n            //             code: item.country_code,\r\n            //             name: item.country_name,\r\n            //             budget: item.budget,\r\n            //             auto_allocate: item.auto_allocate,\r\n            //             budget_allocated: 0,\r\n            //         }\r\n            //         targetCountries.push(itemObj)\r\n            // console.log('TargetCountryCard: save: itemObj', itemObj)\r\n            // }\r\n            // })\r\n\r\n            var targetChannels = []\r\n            this.items.forEach((item) => {\r\n                this.itemLabels.forEach((country) => {\r\n                    if (item[country.checked]) {\r\n                        // console.log('item: ', item)\r\n                        // console.log('item channel_id: ', item['channel_id'])\r\n                        // console.log('item channel_code: ', item['channel_code'])\r\n                        // console.log('item channel_name: ', item['channel_name'])\r\n                        // console.log('item country_id: ', item['country_id'])\r\n                        // console.log('item country_code: ', item['country_code'])\r\n                        // console.log('item country_name: ', item['country_name'])\r\n                        // console.log('item budget: ', item[country.budget])\r\n                        // console.log('item checked: ', item[country.checked])\r\n\r\n                        let itemObj = {\r\n                            target_country: item['country_code'],\r\n                            channel: item['channel_id'],\r\n                            code: item['channel_code'],\r\n                            name: item['channel_name'],\r\n                            budget: item[country.budget],\r\n                            budget_allocated: 0,\r\n                            auto_allocate: true,\r\n                        }\r\n                        targetChannels.push(itemObj)\r\n                    }\r\n                })\r\n            }) -->\r\n<!-- <template v-slot:body=\"{ items }\">\r\n                            <tbody>\r\n                                <tr v-for=\"(item, itemIndex) in items\" :key=\"itemIndex\">\r\n                                    <td>\r\n                                        {{ item.channel_code }}\r\n                                    </td>\r\n                                    <template v-for=\"(labels, labelIndex) in itemLabels\">\r\n                                        <td>\r\n                                            <v-checkbox\r\n                                                v-model=\"item[labels.checked]\"\r\n                                                color=\"secondary\"\r\n                                                :readonly=\"locked\"\r\n                                                dense\r\n                                                hide-details\r\n                                                @change=\"includeChange(item, labels, labelIndex, itemIndex)\"></v-checkbox>\r\n                                        </td>\r\n                                        <td>\r\n                                            <v-text-field\r\n                                                :readonly=\"locked\"\r\n                                                :disabled=\"!item[labels.checked]\"\r\n                                                v-model=\"item[labels.budget]\"\r\n                                                :rules=\"item[labels.checked] ? [rules.notEmpty, rules.inRange] : []\"\r\n                                                label=\"Budget\"\r\n                                                type=\"number\"\r\n                                                dense\r\n                                                hide-details\r\n                                                class=\"shrink rounded-0\"\r\n                                                outlined>\r\n                                            </v-text-field>\r\n                                        </td>\r\n                                    </template>\r\n                                </tr>\r\n                            </tbody>\r\n                        </template> -->\r\n<!-- createHeaders_old() {\r\n    this.headers = []\r\n    // Header 1: Create Channel Header\r\n    var channelCodeHeader = {\r\n        text: 'Channel',\r\n        align: 'center',\r\n        sortable: false,\r\n        value: 'channel_code',\r\n        class: \"black--text text-subtitle-1\",\r\n        width: \"50px\",\r\n    }\r\n    this.headers.push(channelCodeHeader)\r\n\r\n    // Headers 2 to nnn (2 header per country: \r\n    var index = 0\r\n    this.storedTargetCountries.forEach((country) => {\r\n        // Create a header for each country - where we'll place a checkbox \r\n        var countryHeader = {\r\n            text: country.code,\r\n            align: 'start',\r\n            sortable: false,\r\n            value: 'checked' + country.code + index,\r\n            class: \"black--text text-subtitle-1\",\r\n            width: \"50px\",\r\n        }\r\n        this.headers.push(countryHeader)\r\n\r\n        // Create a header for each country budget - where we'll place a budget field\r\n        var budgetHeader = {\r\n            text: 'Budget',\r\n            align: 'center',\r\n            sortable: false,\r\n            value: \"budget\" + country.code + index,\r\n            class: \"black--text text-subtitle-1\",\r\n            width: \"150px\",\r\n        }\r\n        this.headers.push(budgetHeader)\r\n\r\n        // Increment the count used to make the value field name unique\r\n        // This must match the field name in the actual table row\r\n        index += 1\r\n    })\r\n    // console.log('TargetChannelCard:createHeaders:headers: ', this.headers)\r\n},\r\ncreateItemLabels() {\r\n    this.itemLabels = []\r\n    // Create a label for each country and each country budget\r\n    // Used to unqiuely identify a country per channel - and the set the value of the checkbox when\r\n    // we create the data items\r\n    var index = 0\r\n    // console.log(this.storedTargetCountries)\r\n    this.storedTargetCountries.forEach((country) => {\r\n        var checkBoxBudgetLabel = {\r\n            checked: 'checked' + country.code + index,\r\n            budget: 'budget' + country.code + index,\r\n            country_id: 'country_id' + country.code,\r\n            country_code: 'country_code' + country.code,\r\n            country_name: 'country_name' + country.code,\r\n        }\r\n        this.itemLabels.push(checkBoxBudgetLabel)\r\n\r\n        // Increment the count used to make the value field name unique\r\n        // This must match the field name in the header row\r\n        index += 1\r\n    })\r\n    // console.log('TargetChannelCard:createItemLabels:itemLabels: ', this.itemLabels)\r\n},\r\ncreateDataItems() {\r\n    // Table Data\r\n    // Cycle through each country for each channel - creating:\r\n    // Value 1 - channel\r\n    // Value 2 & 3 per country (checkbox - with the checkboxValue label e.g. checkedDE01, checkedGB01) amd budget\r\n    // console.log('TargetChannelCard:createDataItems:this.storedChannels: ', this.storedChannels)\r\n    this.items = []\r\n    this.storedChannels.forEach((channel) => {\r\n        // console.log(this.storedChannels)\r\n        // Value 1: Channel\r\n        var item = {\r\n            'channel_id': channel.id,\r\n            'channel_code': channel.code,\r\n            'channel_name': channel.name,\r\n        }\r\n        // Values 2 to nnn: Country check box AND budget field for each channel / country combination\r\n        var index = 0\r\n        this.storedTargetCountries.forEach((country) => {\r\n            // Set Country Id\r\n            item = Object.assign({\r\n                [this.itemLabels[index].country_id]: country.country,\r\n            }, item)\r\n\r\n            // Set Country Code\r\n            item = Object.assign({\r\n                [this.itemLabels[index].country_code]: country.code,\r\n            }, item)\r\n\r\n            // Set Country Name\r\n            item = Object.assign({\r\n                [this.itemLabels[index].country_name]: country.name,\r\n            }, item)\r\n\r\n            // Set country / channel checkbox value\r\n            item = Object.assign({\r\n                [this.itemLabels[index].checked]: false,\r\n            }, item)\r\n\r\n            // Set country / channel budget value\r\n            item = Object.assign({\r\n                [this.itemLabels[index].budget]: '',\r\n            }, item)\r\n\r\n            index += 1\r\n        })\r\n        this.items.push(item)\r\n        // console.log('TargetChannelCard:createDataItems:item: ', item)\r\n    })\r\n    // console.log('TargetChannelCard:createDataItems:items: ', this.items)\r\n    // console.log('items: ', this.items)\r\n}, -->\r\n<!-- // async getTargetCountries() {\r\n    //     var response = ''\r\n    //     try {\r\n    //         response = await axios.get(`api/v1/targetcountries`, {\r\n    //             params: {\r\n    //                 strategy: this.selectedStrategy.id,\r\n    //             }\r\n    //         })\r\n    //     }\r\n    //     catch (error) {\r\n    //         console.log(error)\r\n    //     }\r\n    //     // Refresh Strategy's Stored  Target Country data \r\n    //     this.$store.dispatch('storeTargetCountries', response.data)\r\n    // },\r\n    // createItems() {\r\n    //     this.items = []\r\n    //     // Table Data - check box AND budget field for each country\r\n    //     var index = 0\r\n    //     this.storedCountries.forEach((country) => {\r\n    //         var item = {\r\n    //             'id': country.id,\r\n    //             'country': country.name,\r\n    //             'include': false,\r\n    //             'budget': '',\r\n    //             'auto_allocate': false,\r\n    //         }\r\n    //         // See if this country is already a target country\r\n    //         let foundTargetCountry = this.storedTargetCountries.find(targetCountry =>\r\n    //             targetCountry.country == item.id\r\n    //         )\r\n    //         // Update table data item with target country settings\r\n    //         if (foundTargetCountry) {\r\n    //             item.include = true\r\n    //             item.budget = foundTargetCountry.budget\r\n    //             item.budget_allocated = foundTargetCountry.budget_allocated\r\n    //             item.auto_allocate = foundTargetCountry.auto_allocate\r\n    //         }\r\n    //         this.items.push(item)\r\n    //     })\r\n    // },\r\n    // save() {\r\n    //     // Build array of countries\r\n    //     this.locked = true\r\n    //     var targetCountries = []\r\n    //     console.log('save: ', this.items)\r\n    //     this.items.forEach((item) => {\r\n    //         if (item.include) {\r\n    //             let itemObj = {\r\n    //                 strategy: this.selectedStrategy.id,\r\n    //                 country: item.id,\r\n    //                 budget: item.budget,\r\n    //                 auto_allocate: item.auto_allocate,\r\n    //                 budget_allocated: 0,\r\n    //             }\r\n    //             targetCountries.push(itemObj)\r\n    //         }\r\n    //     })\r\n    //     this.$emit('update-target-countries', targetCountries)\r\n    // },\r\n    // cancel() {\r\n    //     this.locked = true\r\n    //     this.createItems()\r\n    // } -->"]},"metadata":{},"sourceType":"module"}